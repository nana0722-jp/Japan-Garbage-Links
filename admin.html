<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ごみナビ管理者画面 - Godファイル生成</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            line-height: 1.6;
        }

        #drop-area {
            border: 3px dashed #aaa;
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            font-size: 1.2em;
            color: #777;
            background: #f9f9f9;
            transition: 0.3s;
        }

            #drop-area.hover {
                border-color: #333;
                background: #eee;
            }

        #result {
            margin-top: 20px;
            white-space: pre-wrap;
            background: #333;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        .download-btn {
            display: none;
            margin-top: 10px;
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h1> 🛠 ごみナビ 管理者画面</h1>
    <p> 総務省の「全国地方公共団体コード」Excelを読み込みます。クリックして選択するか、ドラッグ＆ドロップしてください。</p>

    <div id="drop-area" onclick="document.getElementById('fileInput').click()" style="border: 3px dashed #aaa; border-radius: 20px; padding: 50px; text-align: center; font-size: 1.2em; color: #777; background: #f9f9f9; cursor: pointer;">
        ここをクリックしてファイルを選択<br>
        または Excelファイルをドラッグ＆ドロップ
    </div>

    <input type="file" id="fileInput" style="display: none;" accept=".xlsx, .xls">

    <button id="download-btn" style="display: none; margin-top: 20px; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;"> JSONをダウンロード</button>

    <div id="result" style="margin-top: 20px; white-space: pre-wrap; background: #333; color: #fff; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; display: none;"> </div>

    <script>
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('fileInput');
        const resultArea = document.getElementById('result');
        const downloadBtn = document.getElementById('download-btn');
        let generatedJson = null;

        // --- 1. ブラウザのデフォルト動作（ファイルを開く）を徹底ガード ---
        window.addEventListener('dragover', e => e.preventDefault(), false);
        window.addEventListener('drop', e => e.preventDefault(), false);

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        // --- 2. ファイルの読み込み口（ボタン or ドロップ） ---
        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) handleFile(e.target.files[0]);
        });

        dropArea.addEventListener('drop', (e) => {
            if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
        });

        function handleFile(file) {
            dropArea.textContent = "解析中...";
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                processWorkbook(workbook);
            }

                ;
            reader.readAsArrayBuffer(file);
        }

        // --- 3. 解析ロジック（全シート対応版） ---
        function processWorkbook(workbook) {
            let godData = [];
            let codeMap = new Set(); // 重複チェック用のセット

            workbook.SheetNames.forEach(sheetName => {
                const sheet = workbook.Sheets[sheetName];
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                let startRow = -1, startCol = -1, headers = [];

                // 1. 「コード」セルを探す
                for (let i = 0; i < rows.length; i++) {
                    if (!rows[i]) continue;
                    for (let j = 0; j < rows[i].length; j++) {
                        if (String(rows[i][j]).includes('コード')) {
                            startRow = i; startCol = j; break;
                        }
                    }
                    if (startRow !== -1) break;
                }

                if (startRow === -1) return;

                // 2. ヘッダー取得と正規化（表記ゆれ吸収）
                for (let j = startCol; j < rows[startRow].length; j++) {
                    let hName = String(rows[startRow][j] || "").replace(/\s/g, '');
                    if (!hName) break;

                    // 表記ゆれを統一： (漢字) (カナ) (ｶﾅ) などを標準化
                    hName = hName.replace(/（漢字）/g, '')
                        .replace(/（カナ）/g, 'カナ')
                        .replace(/（ｶﾅ）/g, 'カナ')
                        .replace(/別シート/g, '');
                    headers.push(hName);
                }

                // 3. データ抽出
                // データ抽出ループの中
                for (let i = startRow + 1; i < rows.length; i++) {
                    if (!rows[i]) continue;
                    const rawCode = String(rows[i][startCol] || "").trim();

                    if (/^\d{5,6}$/.test(rawCode)) {
                        let rowObj = {};
                        headers.forEach((h, idx) => {
                            let val = rows[i][startCol + idx];
                            rowObj[h] = (val !== undefined && val !== null) ? String(val).trim() : "";
                        });

                        // --- 🌟 政令市の「区」を除外するロジック 🌟 ---
                        // 「政令指定都市名」に何か入っていて、かつ「市区町村名」が空、
                        // または「市区町村名」が既に親の市名を含んでいる場合などは除外
                        // --- 🌟 政令市の「区」を除外するロジック（改良版） 🌟 ---
                        // 1. 政令指定都市名が入っている行を対象にする
                        if (rowObj["政令指定都市名"] && rowObj["政令指定都市名"] !== "") {

                            // 2. 「市区町村名」に「区」という文字が入っていたら、それは「区」の行なのでスキップ
                            // ※市本体の行は、市区町村名が「空」か、政令指定都市名と同じ「市」になっているはずです
                            if (rowObj["市区町村名"] && rowObj["市区町村名"].includes("区")) {
                                continue;
                            }
                        }


                        // --------------------------------------------

                        if (codeMap.has(rawCode)) continue;
                        rowObj["団体コード"] = rawCode;
                        codeMap.add(rawCode);
                        godData.push(rowObj);
                    }
                }

            });

            // 最後にコード順に並び替えるとさらに美しい
            godData.sort((a, b) => parseInt(a.団体コード) - parseInt(b.団体コード));

            generatedJson = godData;
            resultArea.textContent = JSON.stringify(godData, null, 2);
            resultArea.style.display = 'block';
            downloadBtn.style.display = 'inline-block';
            dropArea.textContent = "クレンジング完了！ " + godData.length + "件のユニークなデータを抽出しました。";
        }
        downloadBtn.onclick = () => {
            const blob = new Blob([JSON.stringify(generatedJson, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a .href = url;
            a .download = 'god_cities.json';
            a .click();
        }

            ;
    </script>
</body>
</html>