<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>🔗 ごみナビ：プロ登録エディタ</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            line-height: 1.6;
            background: #f0f2f5;
        }

        .box {
            border: 1px solid #ddd;
            padding: 25px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            border-bottom: 2px solid #28a745;
            padding-bottom: 10px;
        }

        .setup-section {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px dashed #666;
        }

        select, input, button {
            padding: 12px;
            font-size: 16px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

            input[type="text"] {
                width: 100%;
                box-sizing: border-box;
            }

        .flex {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-search {
            background: #4285f4;
            color: white;
            border: none;
            font-weight: bold;
        }

        .btn-save {
            background: #28a745;
            color: white;
            border: none;
            width: 100%;
            margin-top: 15px;
            font-size: 1.1em;
            font-weight: bold;
        }

        .btn-download {
            background: #6c757d;
            color: white;
            border: none;
            cursor: pointer;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .status-done {
            background: #d4edda;
            color: #155724;
        }

        .status-yet {
            background: #f8d7da;
            color: #721c24;
        }

        textarea {
            width: 100%;
            height: 150px;
            font-family: monospace;
            margin-top: 10px;
            background: #f8f9fa;
        }

        .memo-box {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #555;
        }
    </style>
</head>
<body>

    <h1>🔗 ごみナビ：リンク登録エディタ V2</h1>

    <div class="setup-section">
        <strong>【続きから始める】</strong> すでに保存済みの <code>links.json</code> があれば選択してください：
        <input type="file" id="loadInput" accept=".json" onchange="loadExistingLinks(this)">
    </div>

    <div class="box">
        <div class="flex">
            <select id="prefSelect"><option value="">都道府県を選択</option></select>
            <select id="citySelect"><option value="">市区町村を選択</option></select>
            <span id="statusBadge" class="status-badge"></span>
            <button class="btn-search" onclick="searchGoogle()">🔍 Googleで検索</button>
        </div>

        <div style="margin-top: 20px;">
            <label><strong>ゴミ情報のURL:</strong></label>
            <input type="text" id="urlInput" placeholder="https://www.city.example.lg.jp/...">

            <div class="memo-box">
                <label><input type="checkbox" id="checkApp"> アプリあり</label>
                <label><input type="checkbox" id="checkPdf"> PDFのみ</label>
                <input type="text" id="memoInput" placeholder="備考（例：さんあ〜る導入済み）" style="width: 300px; padding: 5px;">
            </div>

            <button class="btn-save" onclick="addToDict()">この自治体情報を保存</button>
        </div>
    </div>

    <div style="margin-top: 30px;">
        <h3>現在の登録進捗: <span id="countDisplay">0</span> 件</h3>
        <textarea id="jsonPreview" readonly placeholder="ここにJSONがリアルタイム生成されます..."></textarea>
        <button class="btn-download" onclick="downloadJSON()" style="width:100%; padding: 15px;">現在の全データを links.json として書き出し</button>
    </div>

    <script>
        let godData = [];
        let linksDict = {}; // { "コード": { url: "", isApp: false, memo: "" } }

        // 1. 起動時に god.json を読み込む
        fetch('god_cities.json')
            .then(response => response.json())
            .then(data => {
                godData = data;
                initPrefSelect();
            })
            .catch(err => alert("god_cities.jsonが見つかりません。"));

        function initPrefSelect() {
            const prefs = [...new Set(godData.map(item => item.都道府県名))];
            const select = document.getElementById('prefSelect');
            prefs.forEach(pref => {
                const opt = document.createElement('option');
                opt.value = opt.textContent = pref;
                select.appendChild(opt);
            });
        }

        // 既存のJSONを読み込む
        function loadExistingLinks(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    linksDict = JSON.parse(e.target.result);
                    updatePreview();
                    alert(Object.keys(linksDict).length + " 件のデータを読み込みました。続きをどうぞ！");
                } catch (err) {
                    alert("JSONの読み込みに失敗しました。");
                }
            };
            reader.readAsText(file);
        }

        document.getElementById('prefSelect').onchange = function () {
            const citySelect = document.getElementById('citySelect');
            citySelect.innerHTML = '<option value="">市区町村を選択</option>';
            const filtered = godData.filter(item => item.都道府県名 === this.value);
            filtered.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.団体コード;
                opt.textContent = (item.市区町村名 || "") + (item.政令指定都市名 || "");
                citySelect.appendChild(opt);
            });
            updateStatus();
        };

        document.getElementById('citySelect').onchange = updateStatus;

        // 選択された自治体のステータスを確認
        function updateStatus() {
            const code = document.getElementById('citySelect').value;
            const badge = document.getElementById('statusBadge');
            const urlInput = document.getElementById('urlInput');
            const memoInput = document.getElementById('memoInput');
            const checkApp = document.getElementById('checkApp');
            const checkPdf = document.getElementById('checkPdf');

            if (!code) {
                badge.textContent = "";
                return;
            }

            if (linksDict[code]) {
                badge.textContent = "✅ 登録済み";
                badge.className = "status-badge status-done";
                const data = linksDict[code];
                // 互換性のため文字列とオブジェクトの両方に対応
                urlInput.value = typeof data === 'string' ? data : data.url;
                memoInput.value = data.memo || "";
                checkApp.checked = data.isApp || false;
                checkPdf.checked = data.isPdf || false;
            } else {
                badge.textContent = "❌ 未登録";
                badge.className = "status-badge status-yet";
                urlInput.value = "";
                memoInput.value = "";
                checkApp.checked = false;
                checkPdf.checked = false;
            }
        }

        function searchGoogle() {
            const pref = document.getElementById('prefSelect').value;
            const cityOpt = document.getElementById('citySelect').selectedOptions[0];
            if (!pref || !cityOpt.value) return alert("自治体を選択してください");
            const query = `${pref} ${cityOpt.textContent} ごみ 分別`;
            window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
        }

        function addToDict() {
            const code = document.getElementById('citySelect').value;
            const url = document.getElementById('urlInput').value.trim();
            if (!code || !url) return alert("URLを入力してください");

            linksDict[code] = {
                url: url,
                isApp: document.getElementById('checkApp').checked,
                isPdf: document.getElementById('checkPdf').checked,
                memo: document.getElementById('memoInput').value.trim(),
                updatedAt: new Date().toLocaleDateString()
            };

            updatePreview();
            updateStatus();
        }

        function updatePreview() {
            document.getElementById('jsonPreview').value = JSON.stringify(linksDict, null, 2);
            document.getElementById('countDisplay').textContent = Object.keys(linksDict).length;
        }

        function downloadJSON() {
            const blob = new Blob([JSON.stringify(linksDict, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'links.json';
            a.click();
        }
    </script>
</body>
</html>